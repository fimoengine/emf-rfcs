- Feature Name: `versioning_specification`
- Start Date: 2021-02-16
- RFC PR: [fimoengine/emf-rfcs#0004](https://github.com/fimoengine/emf-rfcs/pull/0004)

# Summary

[summary]: #summary

This RFC specifies the versioning scheme used by the EMF project.

# Motivation

[motivation]: #motivation

The project needs a consistent solution for identifying incompatibilities and breaking changes.

# Guide-level explanation

[guide-level-explanation]: #guide-level-explanation

A version is any string that matches the following regular expression:

```
\d+\.\d+\.\d+(-(unstable|beta)\.\d+)?(\+\d+)?
```

Examples:

- `1.0.0`
- `1.0.0+512`
- `1.0.0-unstable`
- `1.0.0-unstable+1112`
- `1.0.0-beta.12`
- `1.0.0-beta.12+1215120`

Order:

- `0.1.0 <=₁ 0.1.1 <=₁ 1.0.0`
- `0.1.0-unstable <= 0.1.0-unstable.2 <= 0.1.0-beta <= 0.1.0`
- `1.0.0-beta.3+50 <=₃ 1.0.0-beta.3+51 <=₃ 1.0.0`

Equality:

- `0.1.0 ==₁ 0.1.0-unstable ==₁ 0.1.0-beta.5`
- `0.1.0 == 0.1.0+2 == 0.1.0+100`
- `1.2.3+beta.5+10 ==₃ 1.2.3+beta.5+10`

Compatibility:

- `0.1.0 ~ 0.1.5`
- `1.1.0 ~ 1.2.7`
- `1.0.5-unstable.1+1000 ~ 1.0.5-unstable.1+1151`
- `1.0.5-beta.2+1000 ~ 1.0.5-beta.5+1`

# Reference-level explanation

[reference-level-explanation]: #reference-level-explanation

## Grammar

[grammar]: #grammar

Here is the grammar for a version (EBNF notation):

```
VERSION             = VERSION_CORE, [ RELEASE_IDENTIFIER ], [ BUILD_NUMBER ];
VERSION_CORE        = MAJOR_VERSION, `.`, MINOR_VERSION, `.`, PATCH_VERSION;
RELEASE_IDENTIFIER  = `-`, RELEASE_TYPE, [RELEASE_NUMBER];
BUILD_NUMBER        = `+`, NUMBER;
MAJOR_VERSION       = NUMBER;
MINOR_VERSION       = NUMBER;
PATCH_VERSION       = NUMBER;
RELEASE_TYPE        = `unstable` | `beta`;
RELEASE_NUMBER      = `.`, NUMBER;
NUMBER              = `0` 
                    | DIGIT_WITHOUT_ZERO, { DIGIT }
DIGIT_WITHOUT_ZERO  = `1`
                    | `2`
                    | `3`
                    | `4`
                    | `5`
                    | `6`
                    | `7`
                    | `8`
                    | `9`
                    ;
DIGIT               = `0`
                    | DIGIT_WITHOUT_ZERO
                    ;
```

## Order

[order]: #order

The set of all valid version can be ordered using the three order relations `<=₁` (weak order), `<=₂` (normal order), `<=₃` (strong order). For the sake of brevity, `<=` will be used instead of `<=₂`.

### Weak order

For two versions `v` and `w`, the order generated by `<=₁` is defined as follows:

> 1. Sort by major versions.
> 2. Sort by minor versions.
> 3. Sort by patch versions.

### Normal order

For two versions `v` and `w`, the order generated by `<=` is defined as follows:

> 1. Sort using the `<=₁` operation.
> 2. Sort by release type, with `"unstable" < "beta" < ""`.
> 3. Sort by release number.

### Strong order

For two versions `v` and `w`, the order generated by `<=₃` is defined as follows:

> 1. Sort using the `<=` operation.
> 2. Sort by build number.

## Equality

Using the three order relations, we can define the three equality relationships  `==₁` (weak equality), `==₂` (normal equality), `==₃` (strong equality). For the sake of brevity, `==` will be used instead of `==₂`.

For two versions `v` and `w`, they are defined as follows:

- `v ==₁ w  <=> v <=₁ w ∧ w <=₁ v`
- `v == w <=> v <= w ∧ w <= v`
- `v ==₃ w  <=> v <=₃ w ∧ w <=₃ v`

## Compatibility

Having defined the order and equality of versions, we can define a compatibility relation `~`.
For two versions `v` and `w`, `v ~ w` denotes that `v` is compatible to `w`.
The relation `~` is not symmetric.

In practical terms, having an interface with the versions `v` and `w`, for which `v ~ w` applies, means that the version `w` can be selected instead of `v`, without breaking any guarantees (invariants, constants, functions, etc.) defined in version `v`.

In case the major version of `v` does not equal `0`, `v ~ w` applies if, `v` and `w` share the same major version and `v <= w` applies. Otherwise it is also required, that `v` and `w` share the same minor version. Unstable versions must also satisfy `v == w`, while beta versions must satisfy `v ==₁ w`.

# Drawbacks

[drawbacks]: #drawbacks

This proposed design is rather restrictive when compared with other versioning schemes, as is forces the use of one of the three specified release types.

# Rationale and alternatives

[rationale-and-alternatives]: #rationale-and-alternatives

The specified design should suffice for the scope of the EMF project, as being able to specify compatibilities is more important than having the freedom of a custom versioning scheme.

# Prior art

[prior-art]: #prior-art

A broadly used versioning scheme is [SemVer](https://semver.org/), which is a superset of the versions defined in this specification.

# Unresolved questions

[unresolved-questions]: #unresolved-questions

This RFC tries to represent interface stability as a version. In the case of a lacking stability, such as unstable or beta versions, it remains an open question how the compatibility relation should be defined.

# Future possibilities

[future-possibilities]: #future-possibilities

In the future, we may look into adding more release types.
